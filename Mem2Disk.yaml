name: Windows.Memory.Mem2Disk

precondition: SELECT OS From info() where OS = 'windows'

sources:
  - query: |
    LET GetPids =
      SELECT Pid,
        Username
      FROM pslist()

    LET InfoFromVad = 
      SELECT 
        int(int=split(string=AddressRange, sep="-")[0]) as Address,
        filter(list=ProcessChain, regex=Pid)[0].Exe as Path
      FROM Artifact.Windows.System.VAD(PidRegex=str(str=Pid))
      WHERE MappingName
        AND Protection =~ "xr-"
        AND MappingName =~ "(exe)$"

    LET GetMetadata =
      SELECT Path,
        Address,
        parse_pe(file=Path).Sections[0] AS TextSegmentData
      FROM InfoFromVad

    LET GetContent =
      SELECT *,
        format(format="%#x", args=Address) AS AddressHex,
        format(format="%x",
          args=read_file(accessor="process",
            offset=Address,
            filename=format(format="/%d", args=Pid),
            length=TextSegmentData.Size)
          ) AS MemoryData,
        format(format="%x",
          args=read_file(accessor="file",
            offset=TextSegmentData.FileOffset,
            filename=Path,
            length=TextSegmentData.Size)
          ) AS DiskData
      FROM GetMetadata

    LET Compare =
      SELECT Pid,
        Path,
        TextSegmentData.Size AS Size,
        MemoryData = DiskData AS Comparison
      FROM GetContent
      WHERE NOT comparison

    SELECT * FROM foreach(
      row=GetPids,
      query=Compare
    )
