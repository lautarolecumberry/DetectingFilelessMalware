name: Windows.Memory.Mem2Disk

precondition: SELECT OS From info() where OS = 'windows'

sources:
  - query: |
    LET GetPids =
      SELECT Pid,
        Username
      FROM pslist()

    LET InfoFromVad =
      SELECT Address,
        regex_replace(
          source=MappingName,
          re='.Device.HarddiskVolume[0-9]',
          replace="C:"
        ) as Path
      FROM vad(pid=Pid)
      WHERE MappingName
        AND Protection =~ "xr-"
        AND Path =~ "(exe)$"

    LET GetMetadata =
      SELECT Path,
        Address,
        parse_pe(file=Path).Sections[0] AS TextSegmentData
      FROM InfoFromVad

    LET GetContent =
      SELECT *,
        format(format="%#x", args=Address) AS AddressHex,
        format(format="%x",
          args=read_file(accessor="process",
            offset=Address,
            filename=format(format="/%d", args=Pid),
            length=TextSegmentData.Size)
          ) AS MemoryData,
        format(format="%x",
          args=read_file(accessor="file",
            offset=TextSegmentData.FileOffset,
            filename=Path,
            length=TextSegmentData.Size)
          ) AS DiskData
      FROM GetMetadata

    LET Compare =
      SELECT Pid,
        Path,
        TextSegmentData.Size,
        MemoryData = DiskData AS comparison
      FROM GetContent
      WHERE NOT comparison

    SELECT * FROM foreach(
      row=GetPids,
      query=Compare
    )
